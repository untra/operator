{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://gbqr.us/operator/issuetype-template.schema.json",
  "title": "Issuetype Template Schema",
  "description": "Schema for validating operator issuetype template configurations",
  "type": "object",
  "required": ["key", "name", "description", "mode", "glyph", "fields", "steps"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "JSON Schema reference for validation"
    },
    "key": {
      "type": "string",
      "pattern": "^[A-Z]+$",
      "description": "Unique issuetype key (e.g., FEAT, FIX, SPIKE, INV, TASK)",
      "examples": ["FEAT", "FIX", "SPIKE", "INV", "TASK"]
    },
    "name": {
      "type": "string",
      "minLength": 3,
      "description": "Human-readable name of the issuetype, eg. bug, feature, task, chore, spike, etc."
    },
    "description": {
      "type": "string",
      "description": "Description of what this issuetype is for"
    },
    "mode": {
      "type": "string",
      "enum": ["autonomous", "paired"],
      "description": "Whether this issuetype work runs autonomously or requires human pairing",
      "default": "paired"
    },
    "glyph": {
      "type": "string",
      "minLength": 1,
      "maxLength": 4,
      "description": "Icon/glyph character displayed in the UI for this issuetype (e.g., '*', '#', '!', '?', '>')",
      "examples": ["*", "#", "!", "?", ">"]
    },
    "color": {
      "type": "string",
      "enum": ["white", "blue", "cyan", "green", "yellow", "magenta", "red", "black"],
      "default": "white",
      "description": "Optional color for the glyph in TUI display"
    },
    "project_required": {
      "type": "boolean",
      "description": "Whether a project must be specified for this issuetype",
      "default": true
    },
    "fields": {
      "type": "array",
      "description": "Field definitions for the ticket form",
      "items": {
        "$ref": "#/definitions/field"
      },
      "minItems": 1
    },
    "steps": {
      "type": "array",
      "description": "Lifecycle steps for completing this ticket type",
      "items": {
        "$ref": "#/definitions/step"
      },
      "minItems": 1
    },
    "prompt": {
      "type": "string",
      "description": "Issue prompt to apply to work creation."
    },
    "agent_creation_prompt": {
      "type": "string",
      "description": "Optional prompt for generating an operator agent for this issuetype via 'claude -p' for this prompt. Should instruct Claude to output ONLY the agent system prompt. If omitted, no operator agent will be generated for this issuetype."
    }
  },
  "definitions": {
    "field": {
      "type": "object",
      "required": ["name", "description", "type"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z_]+$",
          "description": "Field identifier (lowercase with underscores)"
        },
        "description": {
          "type": "string",
          "description": "Human-readable description of the field"
        },
        "type": {
          "type": "string",
          "enum": ["string", "text", "enum", "date", "boolean", "integer"],
          "description": "Field data type"
        },
        "required": {
          "type": "boolean",
          "default": false,
          "description": "Whether this field must be filled"
        },
        "default": {
          "type": ["string", "boolean", "integer", "null"],
          "description": "Default value for the field. Required if field is required (except for 'id' field)"
        },
        "min": {
          "type": "integer",
          "description": "Minimum value for integer fields"
        },
        "max": {
          "type": "integer",
          "description": "Maximum value for integer fields"
        },
        "auto": {
          "type": "string",
          "enum": ["id", "date", "branch", "status"],
          "description": "Auto-generation strategy for this field"
        },
        "options": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Available options for enum fields"
        },
        "placeholder": {
          "type": "string",
          "description": "Placeholder text shown in empty field"
        },
        "max_length": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum character length for string/text fields"
        },
        "display_order": {
          "type": "integer",
          "minimum": 0,
          "description": "Order in which to display this field in the form"
        },
        "user_editable": {
          "type": "boolean",
          "default": true,
          "description": "Whether the user can edit this field (false for auto-generated)"
        }
      },
      "allOf": [
        {
          "if": {
            "properties": {
              "type": { "const": "enum" }
            }
          },
          "then": {
            "required": ["options"]
          }
        },
        {
          "if": {
            "properties": {
              "required": { "const": true },
              "auto": false
            },
            "not": {
              "properties": {
                "name": { "const": "id" }
              }
            }
          },
          "then": {
            "required": ["default"]
          }
        }
      ]
    },
    "step": {
      "type": "object",
      "required": ["name", "outputs", "prompt", "allowed_tools"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "description": "Step identifier (lowercase)",
          "pattern": "^[a-z_]+$"
        },
        "display_name": {
          "type": "string",
          "description": "Human-readable step name"
        },
        "outputs": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["plan", "code", "test", "pr", "ticket", "review", "report", "documentation"]
          },
          "description": "Types of outputs this step produces"
        },
        "prompt": {
          "type": "string",
          "description": "Initial prompt template for the Claude agent at this step"
        },
        "allowed_tools": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Claude Code tools allowed in this step (e.g., 'Read', 'Write', 'Bash')"
        },
        "review_type": {
          "type": "string",
          "enum": ["none", "plan", "visual", "pr"],
          "default": "none",
          "description": "Type of review required: none (auto-proceed), plan (approve plan), visual (browser check), pr (GitHub PR review)"
        },
        "visual_config": {
          "type": "object",
          "description": "Configuration for visual review (required when review_type is 'visual')",
          "properties": {
            "url": {
              "type": "string",
              "description": "URL to open for visual check (supports handlebars templates)"
            },
            "startup_command": {
              "type": "string",
              "description": "Optional command to start dev server before opening browser"
            },
            "startup_timeout_secs": {
              "type": "integer",
              "default": 30,
              "description": "Timeout in seconds for server startup"
            }
          },
          "required": ["url"]
        },
        "on_reject": {
          "type": "object",
          "description": "What to do if step output is rejected",
          "properties": {
            "goto_step": {
              "type": "string",
              "description": "Step name to return to on rejection"
            },
            "prompt": {
              "type": "string",
              "description": "Prompt to use when restarting after rejection"
            }
          }
        },
        "next_step": {
          "type": ["string", "null"],
          "description": "Name of the next step (null for final step)"
        },
        "permissions": {
          "$ref": "#/definitions/stepPermissions",
          "description": "Provider-agnostic permissions for this step, merged additively with project settings"
        },
        "cli_args": {
          "$ref": "#/definitions/providerCliArgs",
          "description": "Arbitrary CLI arguments per provider"
        },
        "permission_mode": {
          "type": "string",
          "enum": ["default", "plan", "acceptEdits", "delegate"],
          "default": "default",
          "description": "Preferred LLM permission mode for this step. Only applies to providers that support it (e.g., Claude). No-op for unsupported providers."
        },
        "jsonSchema": {
          "type": "object",
          "description": "Inline JSON schema for structured output. Claude-specific: sets --json-schema flag. Takes precedence over jsonSchemaFile if both are defined."
        },
        "jsonSchemaFile": {
          "type": "string",
          "description": "Path to a local JSON schema file for structured output, relative to the project root. Claude-specific: sets --json-schema flag."
        }
      }
    },
    "stepPermissions": {
      "type": "object",
      "description": "Provider-agnostic permissions for a step",
      "additionalProperties": false,
      "properties": {
        "tools": {
          "type": "object",
          "description": "Tool-level allow/deny lists",
          "additionalProperties": false,
          "properties": {
            "allow": {
              "type": "array",
              "items": { "$ref": "#/definitions/toolPattern" },
              "description": "Tools/patterns to allow (additive to project settings)"
            },
            "deny": {
              "type": "array",
              "items": { "$ref": "#/definitions/toolPattern" },
              "description": "Tools/patterns to deny (additive to project settings)"
            }
          }
        },
        "directories": {
          "type": "object",
          "description": "Directory-level allow/deny lists",
          "additionalProperties": false,
          "properties": {
            "allow": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Additional directories to allow access to (glob patterns)"
            },
            "deny": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Directories to deny access to (glob patterns)"
            }
          }
        },
        "mcp_servers": {
          "type": "object",
          "description": "MCP server enable/disable configuration",
          "additionalProperties": false,
          "properties": {
            "enable": {
              "type": "array",
              "items": { "type": "string" },
              "description": "MCP servers to enable for this step"
            },
            "disable": {
              "type": "array",
              "items": { "type": "string" },
              "description": "MCP servers to disable for this step"
            }
          }
        },
        "custom_flags": {
          "type": "object",
          "description": "Per-provider custom configuration flags",
          "additionalProperties": false,
          "properties": {
            "claude": {
              "type": "object",
              "additionalProperties": true,
              "description": "Claude-specific configuration flags"
            },
            "gemini": {
              "type": "object",
              "additionalProperties": true,
              "description": "Gemini-specific configuration flags"
            },
            "codex": {
              "type": "object",
              "additionalProperties": true,
              "description": "Codex-specific configuration flags"
            }
          }
        }
      }
    },
    "toolPattern": {
      "type": "object",
      "description": "Provider-agnostic tool permission pattern",
      "required": ["tool"],
      "additionalProperties": false,
      "properties": {
        "tool": {
          "type": "string",
          "description": "Tool name: Read, Write, Edit, Bash, Glob, Grep, WebFetch, etc."
        },
        "pattern": {
          "type": "string",
          "description": "Optional pattern for tool arguments (e.g., 'cargo test:*' for Bash)"
        }
      }
    },
    "providerCliArgs": {
      "type": "object",
      "description": "Arbitrary CLI arguments per provider",
      "additionalProperties": false,
      "properties": {
        "claude": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CLI arguments for Claude"
        },
        "gemini": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CLI arguments for Gemini"
        },
        "codex": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CLI arguments for Codex"
        }
      }
    }
  }
}
